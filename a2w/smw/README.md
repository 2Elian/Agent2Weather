# 后端开发问题汇总

为什么不用java来开发后端呢? --> 因为本次重构 会有大量的与LLM交互 为了方便管理 本项目都把提示词写到了python状态管理器中进行统一管理 

LangGraph框架的State是Agent变得智能的关键 我们用一个状态来控制整个流程的走向 所以这边与java频繁的交互 交互部分的代码不太好沟通，其次捕捉异常和badcase的逻辑不太好穿插

## 1. 气象呈阅件的前期实况部分 -> 查日表问题

举几个例子如下：
```bash
一、前期天气实况
降水偏少，气温偏高。12月以来，全市平均降雨量8.3毫米，较常年同期偏少6.7成，县级以万载县19.0毫米为最多，丰城市1.2毫米为最少；全市平均气温10.7℃，较常年同期偏高1.8℃，为1961年以来历史同期第7高位（最高出现在1968年，16.7℃）。

一、前期天气实况
3月 以来 ，全市平均降雨量 47.3 毫米，较常年同期 偏 少 6.4 成 其中 樟树 36.4 毫米较常年偏少 75 最少。

一、前期天气实况
7月 1 日～ 24 日，全市平均降雨量为 47.0 毫米，较常年同期 偏少 7.0 成 ，为 1961 年以来历史同期 第 12 少位 县级以靖安县 100.1 毫米为最多，樟树市 11.7 毫米为最少。 全市日平均气温为 31.1 ℃，较常年同期 偏高 2.4 ℃，破 1961 年以来 历史极值，县级以丰城市 32.1 ℃为最高，铜鼓县 29.6 ℃为最低。 7 月 22 日开始，我市出现了今年入夏以来最炎热天气，有 6 个县（市、区）最高气温超过 39 。根据高温热浪监测， 7 月 23 日我市大部分地区已达到轻度热浪（见 下 图）。xxx
```

最开始的思路：收集起始日期前一周的日表数据，然后交给大模型分析天气类型，然后拼接一下prompt召回1-2个模板，进行写作。

但是有如下几个问题：
- 让大模型判断天气类型，有点浪费整个系统的响应时间
- 召回模板准确率有些低 -> 比如天气类型是 降水偏少，气温偏高的类型，容易召回降水偏多的模板
- 起始日期前一周的数据有时候不够，因为模板里面有很多信息是与往年比较的， 一旦这种模板被召回 那么让LLM生成前期实况的时候 就会导致数据不足 让模型瞎蒙


解决思路：
```bash
1. 收集开始日期到月初的数据，然后基于映射规则得到每个cnty的天气类型 --> (这个映射规则基于气象要素func call来判断，节省响应时间)
2. 基于最多的天气类型，拼接prompt，召回模板(这里我们整个系统需要迭代，我的思路是：给现有的模板打上天气类型标签，然后做标签召回，即省时间又不容易犯错。缺点就是需要不断迭代我们的模板标签以及第一步设计的映射规则，这里前端同学可以给用户一个按钮，如果用户觉得我们系统输出的有问题，那就打一个badcase回调收集)
3. 依据模板的套路，llm-agent做如下的任务：(这样，解决了数据缺失导致大模型胡编乱造的情况发生)
    3.1 query收集
        若想完成类似于以上模板的写作，我需要哪些数据？可用的func call有xxx。 返回一个Dict , 我的开始日期为，结束日期为， 城市为xxx，天气类型为xxx、
        这里期望LLM能分解query 成一个dict，dict里面存每个不同的子query，每个子query是收集数据的query
    3.2 LOOP
        是否有遗漏的？是否有错误的？
    3.3 执行func call得到数据

    3.4 LOOP 如果哪些func call执行失败/没有拿到数据 返回到query理解，重新给一个query

    3.5 模板+query+query结果+最终提示，完成写作。
4. 拿到所有的数据之后，仿照写出来
```

## 2. 气象呈阅件的具体前期预报 -> State管理问题

问题1：
刚开始写的代码：前期实况和具体天气预报需二者都完成 才能开始下一步，这会导致如下问题

- 前期实况内部包含llm-agent意图拆解+意图识别+问询+nl2sql 而具体天气预报只有查数据+llm生成(比较简单，业务逻辑没那么复杂) 而经过业务分析 后续的模块生成只应与具体天气预报有关，所以等待前期实况是没必要的。

解决：
```bash
前期实况仍一个哨兵在那里看着 什么时候完成 完成了进入State即可 如果任务最后它还没完成 那需要等待它完成 输出整个文档结构
```

问题2：查小时表的时候 假设有2个地区 查10个关键气象要素 查5天 那么数据就有：2 * 10 * 5 * 24 = 2400条数据 这样我怕大模型上下文撑不住。

这里还是用日表来计算吧